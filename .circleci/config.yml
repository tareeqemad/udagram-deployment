version: 2.1

orbs:
  aws-cli: circleci/aws-cli@4.1.3

jobs:
  build:
    docker:
      - image: cimg/node:18.19
    steps:
      - checkout

      - run:
          name: Build Frontend
          command: |
            cd udagram/udagram-frontend
            npm install -f
            export NODE_OPTIONS=--openssl-legacy-provider
            npm run lint
            npm run build

      - run:
          name: Build Backend
          command: |
            cd udagram/udagram-api
            npm install
            npm run build || npx tsc

  deploy:
    docker:
      - image: cimg/node:18.19
    steps:
      - checkout

      - aws-cli/setup:
          aws_access_key_id: AWS_ACCESS_KEY_ID
          aws_secret_access_key: AWS_SECRET_ACCESS_KEY
          region: AWS_DEFAULT_REGION

      - run:
          name: Verify AWS credentials (must succeed)
          command: |
            aws --version
            aws sts get-caller-identity
      - run:
          name: Install EB CLI + zip
          command: |
            sudo apt-get update
            sudo apt-get install -y python3-pip zip
            pip3 install --user awsebcli
            echo 'export PATH=$HOME/.local/bin:$PATH' >> $BASH_ENV
            source $BASH_ENV
            eb --version

      - run:
          name: Set EB environment variables from CircleCI secrets
          command: |
            cd udagram/udagram-api
            eb use udagram-api-dev
            
            eb setenv \
              "POSTGRES_USERNAME=${POSTGRES_USERNAME}" \
              "POSTGRES_PASSWORD=${POSTGRES_PASSWORD}" \
              "POSTGRES_HOST=${POSTGRES_HOST}" \
              "POSTGRES_DB=${POSTGRES_DB}" \
              "POSTGRES_PORT=${POSTGRES_PORT}" \
              "AWS_BUCKET=${AWS_BUCKET}" \
              "AWS_REGION=${AWS_REGION}" \
              "JWT_SECRET=${JWT_SECRET}" \
              "URL=${URL}"

      - run:
          name: Deploy Backend (Elastic Beanstalk)
          command: |
            cd udagram/udagram-api
            npm run deploy

      - run:
          name: Deploy Frontend (S3)
          command: |
            export NODE_OPTIONS=--openssl-legacy-provider
            cd udagram/udagram-frontend
            npm run deploy

workflows:
  build_and_deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build
          filters:
            branches:
              only:
                - main
                - master
